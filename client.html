<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Auth Token Tester (Enhanced)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 40px auto; }
    input, button { margin: 5px 0; padding: 8px; width: 100%; box-sizing: border-box; }
    button { background: #007bff; color: white; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .log { margin-top: 15px; background: #f0f0f0; padding: 10px; height: 400px; overflow-y: auto; border: 1px solid #ccc; font-size: 14px; }
    .log div { margin: 2px 0; white-space: pre-wrap; }
    .loading { color: #007bff; font-style: italic; }
    .error { color: #dc3545; }
    .success { color: #28a745; }
  </style>
</head>
<body>
  <h1>Auth Token Tester (with Auto-Refresh)</h1>
  <p>Open browser dev tools (F12) > Network/Application tabs to inspect requests/cookies. Access tokens auto-refresh on expiry (reactive + proactive).</p>

  <div>
    <input type="text" id="name" placeholder="Name (for signup)">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="signupBtn" onclick="signup()">Signup</button>
    <button id="loginBtn" onclick="login()">Login</button>
    <button id="getProtectedBtn" onclick="getProtected()">Get Protected Data</button>
    <button id="logoutBtn" onclick="logout()">Logout</button>
    <div id="status" style="margin: 10px 0; font-weight: bold;"></div>
  </div>

  <div class="log" id="log"></div>

  <div id="locationSection" class="section" style="display:none;">
    <h2>Location Sharing</h2>
    <label>Target User ID: <input type="text" id="targetId" placeholder="User ID to share location with"></label>
    <button id="connectWsBtn">Connect WebSocket</button>
    <div>
      <h3>Your Location:</h3>
      <button onclick="getLocation()">Get Current Location</button>
      <label>Latitude: <input type="number" id="lat" step="any"></label>
      <label>Longitude: <input type="number" id="lng" step="any"></label>
      <button id="sendLocationBtn">Send Location</button>
    </div>
  </div>

  <script>
    const API_URL = "http://localhost:3000";
    let accessToken = null;
    let isRefreshing = false;

    function log(msg, type = 'info') {
      const logDiv = document.getElementById("log");
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
      logDiv.innerHTML += `<div class="${className}">> ${timestamp}: ${msg}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateStatus(msg, isLoading = false) {
      const statusDiv = document.getElementById("status");
      statusDiv.textContent = msg;
      statusDiv.className = isLoading ? 'loading' : '';
      document.querySelectorAll('button').forEach(btn => btn.disabled = isLoading);
    }

    function decodeToken(token) {
      if (!token) return null;
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        payload.expDate = new Date(payload.exp * 1000);
        return payload;
      } catch (err) {
        log("‚ö†Ô∏è Invalid token format", 'error');
        return null;
      }
    }

    function isTokenExpiringSoon() {
      if (!accessToken) return true;
      const decoded = decodeToken(accessToken);
      if (!decoded) return true;
      const timeLeft = decoded.expDate - new Date();
      return timeLeft < 5 * 60 * 1000;
    }

    function isTokenExpired() {
      if (!accessToken) return true;
      const decoded = decodeToken(accessToken);
      if (!decoded) return true;
      return decoded.expDate < new Date();
    }

    async function refreshToken() {
      if (isRefreshing) {
        log("‚è≥ Refresh already in progress...");
        return false;
      }
      isRefreshing = true;
      updateStatus("Refreshing token...", true);

      try {
        const res = await fetch(`${API_URL}/refresh`, {
          method: "POST",
          credentials: "include"
        });
        const data = await res.json();

        if (res.ok) {
          accessToken = data.accessToken;
          log("üîÑ Token refreshed successfully!", 'success');
          updateStatus("Session active", false);
          return true;
        } else {
          log(`‚ùå Refresh failed: ${data.error || "Unknown error"}`, 'error');
          accessToken = null;
          updateStatus("Session expired - please login", false);
          return false;
        }
      } catch (err) {
        log(`‚ö†Ô∏è Refresh network error: ${err.message}`, 'error');
        accessToken = null;
        return false;
      } finally {
        isRefreshing = false;
        updateStatus("", false);
      }
    }

    async function apiCall(url, options = {}) {
      if (isTokenExpired()) {
        log("‚è∞ Token expiring soon - refreshing proactively...");
        const refreshed = await refreshToken();
        if (!refreshed) {
          throw new Error("Proactive refresh failed - please login");
        }
      }

      const headers = {
        ...options.headers,
        ...(accessToken ? { Authorization: `Bearer ${accessToken}` } : {}),
      };

      let res = await fetch(url, {
        ...options,
        headers,
        credentials: "include"
      });

      if (res.status === 401 && !isRefreshing) {
        log("‚ö†Ô∏è Unauthorized (expired token) - attempting refresh...");
        const refreshed = await refreshToken();
        if (refreshed) {
          headers.Authorization = `Bearer ${accessToken}`;
          res = await fetch(url, { ...options, headers, credentials: "include" });
        } else {
          throw new Error("Refresh failed - session expired");
        }
      }

      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        throw new Error(data.error || `HTTP ${res.status}`);
      }

      return res.json();
    }

    async function checkSession() {
      updateStatus("Checking session...", true);
      try {
        const res = await fetch(`${API_URL}/refresh`, {
          method: "POST",
          credentials: "include"
        });

        if (res.ok) {
          const data = await res.json();
          accessToken = data.accessToken;
          log("üëã Session restored from cookie!", 'success');
          updateStatus("Logged in (restored)", false);
          document.getElementById('locationSection').style.display = '';
        } else {
          updateStatus("Not logged in", false);
        }
      } catch {
        updateStatus("Not logged in", false);
      }
    }

    async function signup() {
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      if (!name || !email || !password) {
        log("‚ùå Please enter name, email, and password for signup.", 'error');
        return;
      }

      updateStatus("Signing up...", true);
      try {
        const res = await fetch(`${API_URL}/signup`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, email, password }),
          credentials: "include"
        });
        const data = await res.json();

        if (res.ok) {
          log("‚úÖ Signed up successfully! You can now login.", 'success');
          updateStatus("Signed up", false);
        } else {
          log(`‚ùå Signup failed: ${data.error || "Unknown error"}`, 'error');
          updateStatus("", false);
        }
      } catch (err) {
        log(`‚ö†Ô∏è Signup network error: ${err.message}`, 'error');
        updateStatus("", false);
      }
    }

    async function login() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      if (!email || !password) {
        log("‚ùå Please enter email and password.", 'error');
        return;
      }

      updateStatus("Logging in...", true);
      try {
        const res = await fetch(`${API_URL}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
          credentials: "include"
        });
        const data = await res.json();

        if (res.ok) {
          accessToken = data.accessToken;
          log("‚úÖ Logged in successfully! Access token received.", 'success');
          updateStatus("Logged in", false);
          document.getElementById('locationSection').style.display = '';
        } else {
          log(`‚ùå Login failed: ${data.error || "Unknown error"}`, 'error');
          updateStatus("", false);
        }
      } catch (err) {
        log(`‚ö†Ô∏è Login network error: ${err.message}`, 'error');
        updateStatus("", false);
      }
    }

    async function getProtected() {
      if (!accessToken && !isRefreshing) {
        log("‚ö†Ô∏è No access token - login first!", 'error');
        return;
      }

      updateStatus("Fetching protected data...", true);
      try {
        const data = await apiCall(`${API_URL}/dashboard`);
        log("üîí Protected data received:", 'success');
        log(JSON.stringify(data, null, 2));
        updateStatus("Data loaded", false);
      } catch (err) {
        log(`‚ùå Failed to get protected data: ${err.message}`, 'error');
        if (err.message.includes("session expired") || err.message.includes("login")) {
          accessToken = null;
          updateStatus("Session expired - please login", false);
        } else {
          updateStatus("", false);
        }
      }
    }

    async function logout() {
      updateStatus("Logging out...", true);
      try {
        await fetch(`${API_URL}/logout`, {
          method: "POST",
          credentials: "include"
        });
        accessToken = null;
        log("üëã Logged out successfully!", 'success');
        updateStatus("Logged out", false);
        document.getElementById('locationSection').style.display = 'none';
      } catch (err) {
        log(`‚ö†Ô∏è Logout error: ${err.message}`, 'error');
        accessToken = null;
        updateStatus("Logged out (manual clear)", false);
        document.getElementById('locationSection').style.display = 'none';
      }
    }

    let ws;
    let isIdentified = false;

    // WebSocket connection and identification (using accessToken)
    document.getElementById('connectWsBtn').onclick = function() {
      ws = new WebSocket('ws://localhost:3000');
      isIdentified = false;
      ws.onopen = function() {
        log('WebSocket connected');
        if (!accessToken) {
          log('No access token found - please login again', 'error');
          return;
        }
        ws.send(JSON.stringify({
          type: 'identify',
          accessToken: accessToken,
          targetId: document.getElementById('targetId').value
        }));
      };
      ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        log('WS: ' + JSON.stringify(data));
        if (data.type === 'identified') {
          isIdentified = true;
          log('WebSocket identified. You can now share your location.', 'success');
        }
        if (data.type === 'location-update') {
          log(`Location from ${data.from}: lat=${data.lat}, lng=${data.lng}`, 'success');
        }
      };
      ws.onclose = function() {
        log('WebSocket disconnected');
        isIdentified = false;
      };
    };

    // Send location only if identified
    document.getElementById('sendLocationBtn').onclick = function() {
      if (!ws || ws.readyState !== 1) {
        log('WebSocket not connected', 'error');
        return;
      }
      if (!isIdentified) {
        log('You must be identified before sending location!', 'error');
        return;
      }
      const lat = parseFloat(document.getElementById('lat').value);
      const lng = parseFloat(document.getElementById('lng').value);
      const targetId = document.getElementById('targetId').value;
      ws.send(JSON.stringify({
        type: 'location', // <-- Include targetId here
        lat: lat,
        lng: lng,
        targetId: String(targetId)
      }));
      log(`Location sent to ${targetId}: lat=${lat}, lng=${lng}`, 'success');
    };

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          document.getElementById('lat').value = position.coords.latitude;
          document.getElementById('lng').value = position.coords.longitude;
          log('Location fetched from browser', 'success');
        });
      } else {
        log('Geolocation is not supported by this browser.', 'error');
      }
    }

    window.addEventListener('load', checkSession);
  </script>
</body>
</html>